# 新接口快速启动指南 🚀

本指南帮助你快速启动和测试所有新增的 API 接口。

---

## 📋 新增功能概览

根据接口文档，已实现以下新功能模块：

### ✅ 已实现的接口（共 15 个）

#### 1. 汇率数据采集与查询（3个接口）
- ✅ 获取系统支持的币种
- ✅ 获取最新实时汇率
- ✅ 查询历史汇率

#### 2. 数据统计分析（1个接口）
- ✅ 获取汇率统计摘要

#### 3. 用户资产管理（3个接口）
- ✅ 查询个人资产记录
- ✅ 添加/修改资产
- ✅ 删除资产记录

#### 4. 智能辅助功能（1个接口）
- ✅ 生成行情解读

#### 5. 管理后台控制（1个接口）
- ✅ 手动触发数据采集

#### 6. 原有接口（6个接口）
- ✅ 用户管理（注册、查询、更新、删除）
- ✅ 市场数据（获取所有汇率、获取单个汇率）

---

## 🗄️ 数据库准备

### 步骤 1：登录 MySQL

```bash
mysql -u root -p
```

### 步骤 2：执行初始化脚本

```sql
-- 执行基础表创建
SOURCE src/main/resources/sql/init.sql;

-- 执行扩展表创建（新增）
SOURCE src/main/resources/sql/update_tables.sql;
```

### 步骤 3：验证表结构

```sql
USE cryptorate;
SHOW TABLES;
```

你应该看到以下表：
- ✅ `user` - 用户表
- ✅ `rate_history` - 汇率历史表（新增）
- ✅ `user_asset` - 用户资产表（新增）

### 步骤 4：查看测试数据

```sql
-- 查看用户数据
SELECT * FROM user;

-- 查看汇率历史数据
SELECT * FROM rate_history;

-- 查看用户资产数据
SELECT * FROM user_asset;
```

---

## 🚀 启动项目

### 方式 1：使用 Maven

```bash
cd CryptoRate
mvn spring-boot:run
```

### 方式 2：打包后运行

```bash
mvn clean package
java -jar target/CryptoRate-1.0-SNAPSHOT.jar
```

### 启动成功标志

```
=================================================
     CryptoRate 加密货币追踪系统启动成功！
     访问地址: http://localhost:8080
=================================================
```

---

## 🧪 快速测试（5 分钟验证）

### 测试 1：同步数据到数据库

**目的**：从 Coinlayer API 获取数据并保存到数据库

```bash
curl -X POST http://localhost:8080/api/v1/admin/sync
```

**预期结果**：
```json
{
  "code": 200,
  "msg": "success",
  "data": "成功同步 150 条汇率数据"
}
```

---

### 测试 2：查询支持的币种

```bash
curl http://localhost:8080/api/v1/rates/symbols
```

**预期结果**：
```json
{
  "code": 200,
  "data": ["BTC", "ETH", "USDT", ...]
}
```

---

### 测试 3：获取最新汇率

```bash
# 获取所有币种的最新汇率
curl http://localhost:8080/api/v1/rates/latest

# 只获取 BTC 的汇率
curl "http://localhost:8080/api/v1/rates/latest?symbol=BTC"
```

---

### 测试 4：查询历史汇率

```bash
curl "http://localhost:8080/api/v1/rates/history?symbol=BTC&start=2024-05-01&end=2024-05-10"
```

---

### 测试 5：获取统计摘要

```bash
# 7 天统计
curl "http://localhost:8080/api/v1/stats/summary/BTC?range=7d"

# 30 天统计
curl "http://localhost:8080/api/v1/stats/summary/BTC?range=30d"
```

---

### 测试 6：资产管理

**添加资产**：
```bash
curl -X POST http://localhost:8080/api/v1/assets \
  -H "Content-Type: application/json" \
  -d '{"symbol":"BTC","amount":0.5}'
```

**查询资产**：
```bash
curl http://localhost:8080/api/v1/assets
```

**删除资产**：
```bash
curl -X DELETE http://localhost:8080/api/v1/assets/1
```

---

### 测试 7：行情解读

```bash
curl http://localhost:8080/api/v1/analysis/explain/BTC
```

---

## 📊 Postman 测试

### 推荐测试顺序

1. **数据采集**
   - POST `/api/v1/admin/sync` - 同步数据

2. **基础查询**
   - GET `/api/v1/rates/symbols` - 查询币种
   - GET `/api/v1/rates/latest` - 最新汇率
   - GET `/api/v1/rates/history` - 历史汇率

3. **统计分析**
   - GET `/api/v1/stats/summary/BTC` - 统计摘要

4. **资产管理**
   - POST `/api/v1/assets` - 添加资产
   - GET `/api/v1/assets` - 查询资产
   - DELETE `/api/v1/assets/{id}` - 删除资产

5. **智能分析**
   - GET `/api/v1/analysis/explain/BTC` - 行情解读

详细的 Postman 测试步骤请查看：`API接口文档与测试指南.md`

---

## 🗂️ 项目文件说明

### 新增的实体类
- `RateHistory.java` - 汇率历史记录实体
- `UserAsset.java` - 用户资产实体

### 新增的 DTO 类
- `LatestRateDTO.java` - 最新汇率数据传输对象
- `HistoryRateDTO.java` - 历史汇率数据传输对象
- `StatsSummaryDTO.java` - 统计摘要数据传输对象
- `AssetDTO.java` - 资产数据传输对象
- `AnalysisReportDTO.java` - 行情解读报告数据传输对象

### 新增的 Mapper
- `RateHistoryMapper.java` + `RateHistoryMapper.xml`
- `UserAssetMapper.java` + `UserAssetMapper.xml`

### 新增的 Service
- `RateService.java` - 汇率数据服务
- `StatsService.java` - 统计分析服务
- `AssetService.java` - 资产管理服务
- `AnalysisService.java` - 智能分析服务

### 新增的 Controller
- `RateController.java` - 汇率查询接口
- `StatsController.java` - 统计分析接口
- `AssetController.java` - 资产管理接口
- `AnalysisController.java` - 智能分析接口
- `AdminController.java` - 管理后台接口

### 扩展的服务
- `CryptoMarketService.java` - 新增了 `syncRatesToDatabase()` 方法

---

## 🔍 接口 URL 规则

### 新增接口（遵循 RESTful 规范）
- Base URL: `http://localhost:8080/api/v1`
- 示例：`/api/v1/rates/latest`

### 原有接口（保持不变）
- Base URL: `http://localhost:8080`
- 示例：`/market/rates`、`/user/register`

---

## 📈 数据流程

### 1. 数据采集流程

```
Coinlayer API → OkHttp 请求 → CryptoMarketService
                                      ↓
                            syncRatesToDatabase()
                                      ↓
                            RateHistoryMapper.batchInsert()
                                      ↓
                            MySQL (rate_history 表)
```

### 2. 数据查询流程

```
HTTP 请求 → RateController → RateService → RateHistoryMapper
                                                  ↓
                                        MySQL (rate_history 表)
                                                  ↓
                                        转换为 DTO 并返回
```

### 3. 资产管理流程

```
HTTP 请求 → AssetController → AssetService → UserAssetMapper
                                                   ↓
                                         MySQL (user_asset 表)
                                                   ↓
                                    获取最新汇率并计算总价值
                                                   ↓
                                         转换为 DTO 并返回
```

---

## 🐛 常见问题

### Q1: 接口返回 404 错误？

**原因**：URL 路径错误或项目未启动

**解决方案**：
- 检查 URL 是否正确（新接口需要 `/api/v1` 前缀）
- 确认项目已启动

---

### Q2: 查询历史汇率返回空数组？

**原因**：数据库中没有对应时间范围的数据

**解决方案**：
1. 执行 `update_tables.sql` 脚本插入测试数据
2. 调用 `/api/v1/admin/sync` 接口同步实时数据
3. 调整查询的时间范围参数

---

### Q3: 同步数据接口调用失败？

**错误信息**：`Coinlayer API 错误: [101] Invalid API Key`

**解决方案**：
- 检查 `application.yml` 中的 API Key 是否正确
- 确认 Coinlayer API 还有剩余调用次数

---

### Q4: 资产查询返回空数组？

**原因**：当前用户（ID=1）没有添加任何资产

**解决方案**：
1. 先调用 `POST /api/v1/assets` 添加资产
2. 或执行 `update_tables.sql` 脚本插入测试数据

---

## ✅ 功能验证清单

测试完成后，请检查以下功能：

- [ ] 数据同步接口正常工作
- [ ] 可以查询支持的币种列表
- [ ] 可以获取最新实时汇率（全部/单个）
- [ ] 可以查询历史汇率数据
- [ ] 统计摘要计算正确（最大值、最小值、平均值、涨跌幅）
- [ ] 可以添加/修改/删除资产
- [ ] 资产查询时正确计算当前价值
- [ ] 行情解读生成合理的分析报告
- [ ] 所有接口返回统一的响应格式
- [ ] 错误情况返回正确的错误码和提示信息

---

## 📚 相关文档

- **完整 API 文档**：`API接口文档与测试指南.md`
- **项目说明**：`README.md`
- **原接口文档**：`加密货币汇率数据处理系统 - 接口文档.md`

---

## 🎉 恭喜！

你已经成功实现了接口文档中定义的所有接口！

**接口统计**：
- ✅ 汇率查询接口：3 个
- ✅ 统计分析接口：1 个
- ✅ 资产管理接口：3 个
- ✅ 智能分析接口：1 个
- ✅ 管理后台接口：1 个
- ✅ 原有接口：6 个
- **总计：15 个接口**

现在可以使用 Postman 进行完整的功能测试了！🚀
