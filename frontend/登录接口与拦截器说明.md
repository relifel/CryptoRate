# 登录与注册接口及拦截器说明

本文档说明前端登录页使用的**登录接口**、**注册接口**及**请求/响应拦截器**的约定与用法。

---

## 一、登录接口（后端）

### 1.1 接口信息

| 项目 | 说明 |
|------|------|
| 方法 | `POST` |
| 路径 | `/user/login` |
| 完整 URL | `http://localhost:8080/user/login`（以实际后端地址为准） |
| Content-Type | `application/json` |

### 1.2 请求体

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码（当前明文，生产环境建议加密） |

**示例：**

```json
{
  "username": "testuser",
  "password": "123456"
}
```

### 1.3 响应

**成功（HTTP 200，业务码 200）：**

```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "createdAt": "2026-02-13 10:30:00"
  },
  "timestamp": 1705924800000
}
```

| 字段 | 说明 |
|------|------|
| code | 业务状态码，200 表示成功 |
| msg | 提示信息 |
| data | 登录用户信息（不含密码） |
| data.id | 用户 ID |
| data.username | 用户名 |
| data.email | 邮箱（可选） |
| data.createdAt | 注册/创建时间 |

**失败：**

- **400**：参数缺失（如未传用户名或密码）  
  `{ "code": 400, "msg": "请输入用户名和密码" }`
- **401**：用户名或密码错误  
  `{ "code": 401, "msg": "用户名或密码错误" }`

### 1.4 前端调用方式

```javascript
import { userAPI } from './api';

const res = await userAPI.login({ username: 'testuser', password: '123456' });
// res.data 为登录用户信息，可写入 state 或 localStorage
```

---

## 二、注册接口（后端）

### 2.1 接口信息

| 项目 | 说明 |
|------|------|
| 方法 | `POST` |
| 路径 | `/user/register` |
| 完整 URL | `http://localhost:8080/user/register`（以实际后端地址为准） |
| Content-Type | `application/json` |

### 2.2 请求体

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名（唯一） |
| password | string | 是 | 密码（当前明文存储，生产环境建议加密） |
| email | string | 否 | 邮箱 |

**示例：**

```json
{
  "username": "newuser",
  "password": "123456",
  "email": "newuser@example.com"
}
```

### 2.3 响应

**成功（HTTP 200，业务码 200）：**

```json
{
  "code": 200,
  "msg": "注册成功",
  "data": {
    "id": 2,
    "username": "newuser",
    "email": "newuser@example.com",
    "createdAt": "2026-02-13 11:00:00"
  },
  "timestamp": 1705924800000
}
```

| 字段 | 说明 |
|------|------|
| code | 业务状态码，200 表示成功 |
| msg | 提示信息 |
| data | 新注册用户信息（不含密码） |
| data.id | 用户 ID |
| data.username | 用户名 |
| data.email | 邮箱（可选） |
| data.createdAt | 注册时间 |

**失败：**

- **400**：参数缺失或用户名已存在  
  `{ "code": 400, "msg": "请输入用户名和密码" }` 或 `{ "code": 400, "msg": "用户名已存在" }`
- **500**：注册失败（如数据库异常）  
  `{ "code": 500, "msg": "用户注册失败" }`

### 2.4 前端调用方式

```javascript
import { userAPI } from './api';

const res = await userAPI.register({
  username: 'newuser',
  password: '123456',
  email: 'newuser@example.com'  // 可选
});
// res.data 为新用户信息，注册成功后可直接作为登录态写入 state / localStorage
```

---

## 三、前端拦截器

### 3.1 请求拦截器

- **作用**：在**已登录**状态下，为除登录/注册以外的请求自动附加身份头，便于后端做登录校验（若后端实现校验逻辑）。
- **实现位置**：`src/api/index.js` 中的 `attachAuthHeaders`。
- **规则**：
  - 从 `localStorage` 读取 key 为 `cryptorate_user` 的登录用户信息。
  - 若存在且当前请求 URL 不包含 `/user/login`、`/user/register`，则在请求头中附加：
    - `X-User-Id`：用户 ID
    - `X-Username`：用户名
  - 登录、注册请求不附加上述头，避免无意义带参。

### 3.2 响应拦截器

- **作用**：当任意接口返回**业务码 401** 时，视为登录失效，清除本地登录态并通知应用打开登录页。
- **实现位置**：`src/api/index.js` 中的 `handleResponseAuth` 及通用 `request` 函数。
- **规则**：
  1. 解析响应 JSON 后若 `data.code === 401`：
     - 删除 `localStorage` 中的 `cryptorate_user`。
     - 派发自定义事件 `auth:logout`。
  2. `App.jsx` 监听 `auth:logout`，执行：清除用户 state、打开登录页（`setShowLoginPage(true)`）。

### 3.3 登录态存储

- **Key**：`cryptorate_user`（与 `App.jsx` 中 `USER_STORAGE_KEY` 一致）。
- **内容**：登录/注册接口返回的 `data` 的 JSON 字符串（含 `id`、`username`、`email`、`createdAt` 等）。
- **写入时机**：登录成功或注册成功后由 `App.jsx` 写入。
- **清除时机**：用户点击「退出」或响应拦截器收到 401 时清除。

---

## 四、登录页与注册流程

### 4.1 页面行为

- **入口**：顶部「登录」→ 展示登录/注册页（`src/pages/Login.jsx`）。
- **切换**：页面支持「登录」与「注册」两种模式，通过「去注册」「去登录」切换。
- **登录**：输入用户名、密码 → 提交 → 调用 `userAPI.login` → 成功则写入用户并关闭页面。
- **注册**：输入用户名、密码、邮箱（选填）→ 提交 → 调用 `userAPI.register` → 成功则直接将返回的 `data` 作为登录态写入并关闭页面（即注册成功后自动登录）。

### 4.2 流程简述

1. **打开登录页**：用户点击顶部「登录」→ 展示登录页（默认登录模式）。
2. **登录**：输入用户名、密码 → 调用 `userAPI.login` → 后端校验 → 返回 200 或 401/400；成功则写入 state 与 `localStorage`，关闭登录页。
3. **注册**：点击「去注册」→ 输入用户名、密码、邮箱（选填）→ 调用 `userAPI.register` → 后端校验（用户名唯一等）→ 返回 200 或 400/500；成功则直接将 `res.data` 写入 state 与 `localStorage`，关闭登录页（自动登录）。
4. **登录失效**：某次请求返回 401 → 响应拦截器清除 `cryptorate_user` 并派发 `auth:logout` → App 监听后清空用户并再次打开登录页。
5. **退出登录**：用户点击「退出」→ 清空 state 与 `localStorage` 中的用户信息。

---

## 五、后端扩展建议（可选）

若需对「需登录」的接口做校验，可：

- 在过滤器中读取请求头 `X-User-Id`、`X-Username`，校验是否与当前会话或 token 一致。
- 校验失败时返回 `{ "code": 401, "msg": "请重新登录" }`，前端会按上述响应拦截器逻辑处理并跳转登录页。

---

## 六、相关文件

| 文件 | 说明 |
|------|------|
| `src/api/index.js` | 请求/响应拦截器、`userAPI.login`、`userAPI.register` |
| `src/pages/Login.jsx` | 登录/注册页组件（支持登录与注册切换） |
| `src/App.jsx` | 登录态 state、监听 `auth:logout`、写入/清除 localStorage |
