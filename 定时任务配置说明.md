# 定时获取价格 - 配置说明

## ★ 最快方式：改 application.yml（不用改 Java 代码）

打开文件：

```
CryptoRate/src/main/resources/application.yml
```

找到末尾的 `scheduler` 节点，直接修改数值，重启后端即可生效：

```yaml
scheduler:
  initial-delay-ms: 30000          # 程序启动后等待多少毫秒再执行第一次（当前 30 秒）
  rate-sync-interval-ms: 86400000  # ★ 改这里！每隔多少毫秒采集一次（当前 24 小时）
```

### 常用间隔对照表

| 想要的频率 | 填写的毫秒值 | 每月消耗次数 | 是否超出免费限额（100次/月） |
|-----------|------------|------------|--------------------------|
| 每 24 小时 | `86400000` | ≈ 30 次 | ✅ 推荐，安全 |
| 每 12 小时 | `43200000` | ≈ 60 次 | ✅ 安全 |
| 每  6 小时 | `21600000` | ≈ 120 次 | ❌ 超限 |
| 每  1 小时 | `3600000`  | ≈ 720 次 | ❌ 严重超限 |
| 每 30 分钟 | `1800000`  | ≈ 1440 次 | ❌ 严重超限 |

> ⚠️ **Coinlayer 免费套餐每月只有 100 次请求额度。**  
> 超过后接口会返回 `HTTP 429 Too Many Requests`，数据采集将暂停直到下月重置。  
> 如需更高频率，请到 [https://coinlayer.com](https://coinlayer.com) 升级付费套餐。

---

## 文件位置总览

需要关注的文件只有以下几个：

```
CryptoRate/
├── src/main/resources/
│   └── application.yml                         ← ★ 改采集频率就改这里（推荐）
└── src/main/java/com/cryptorate/
    ├── CryptoRateApplication.java              ← 已加 @EnableScheduling，无需修改
    ├── scheduler/
    │   └── RateScheduler.java                  ← 定时任务入口（读取 yml 中的间隔值）
    └── service/
        └── CryptoMarketService.java            ← 实际执行 API 调用 + 写库逻辑
```

---

## 如果想用 cron 表达式（精确控制时间点）

打开 `scheduler/RateScheduler.java`，把 `@Scheduled` 改为：

```java
// 每天凌晨 2 点整执行
@Scheduled(cron = "0 0 2 * * ?")
public void syncRatesPeriodically() { ... }
```

常用 cron 表达式：

| 表达式 | 含义 |
|--------|------|
| `0 0 2 * * ?` | 每天 02:00 |
| `0 0 0,12 * * ?` | 每天 0 点和 12 点 |
| `0 0 */12 * * ?` | 每 12 小时 |
| `0 0 */6 * * ?` | 每 6 小时 |

---

## 关于 HTTP 429 错误

**错误含义**：你的 Coinlayer API Key 当月已超出 100 次免费调用额度。

**解决方法**（按推荐顺序）：

1. **调低采集频率**（最简单）  
   在 `application.yml` 中将 `rate-sync-interval-ms` 改为 `86400000`（24 小时），等下月额度重置即可恢复正常。

2. **升级 Coinlayer 套餐**  
   登录 [https://coinlayer.com/product](https://coinlayer.com/product) 升级为付费计划以获得更多调用次数。

3. **更换 API 数据源**  
   可以换用 [CoinGecko 免费 API](https://www.coingecko.com/api/documentation)（每分钟 10-30 次调用，无月限），只需修改 `CryptoMarketService.java` 中的请求 URL 和响应解析逻辑。

---

## 修改后如何重启后端

```bash
# 在 CryptoRate 目录下执行
mvn spring-boot:run
```

重启后日志中可看到定时任务首次触发的输出：

```
[定时任务] 2026-02-20 08:00:30 开始自动同步汇率数据...
[定时任务] 2026-02-20 08:00:32 自动同步完成，共写入 150 条记录
```

若仍有 429，日志只会打印一行 WARN 提示，不影响程序运行：

```
[定时任务] 2026-02-20 08:00:30 Coinlayer API 调用次数已超出免费限额（HTTP 429）...
```
